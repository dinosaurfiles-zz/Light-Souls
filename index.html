<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="lib/quintus.js"></script>
    <script src="lib/quintus_sprites.js"></script>
    <script src="lib/quintus_scenes.js"></script>
    <script src="lib/quintus_input.js"></script>
    <script src="lib/quintus_anim.js"></script>
    <script src="lib/quintus_2d.js"></script>
    <script src="lib/quintus_touch.js"></script>
    <script src="lib/quintus_ui.js"></script>
</head>

<body style="background-color: black;">
    <script>
        var fireb = true;
        var Q = Quintus()
            .include("Sprites, Scenes, Input, 2D, Touch, UI")
            .setup({
                width: 960,
                height: 640,
                development: true
            }).controls().touch();

        //player
        Q.Sprite.extend("Player", {
            init: function(p) {
                this._super(p, {
                    asset: "wizard.png",
                    x: 410,
                    y: 50,
                    jumpSpeed: -540,
                    life: 3,
                    currentAmmo: 5,
                    hasKey: false,
                    gravity: 1
                });
                this.add("2d, platformerControls");

                this.firebFunction = function() {
                    fireb = true;
                }
                this.fire = function() {
                    if (fireb) {
                        if (this.p.currentAmmo > 0) {

                            var tempX = 36;
                            var tempVX = 500;
                            var tempFlip = false;
                            if (this.p.direction == "left") {
                                tempX = -36;
                                tempVX = -500;
                                tempFlip = "x";
                            }
                            var bull = window.bull = new Q.Bullet({
                                w: 20,
                                h: 20,
                                x: this.p.x + tempX,
                                y: this.p.y,
                                vx: tempVX,
                                gravity: 0,
                                flip: tempFlip
                            });
                            Q.stage().insert(bull);
                            fireb = false;
                            this.p.currentAmmo--;
                            setTimeout(this.firebFunction, 1000);
                        }
                    }
                    console.log(this.p.currentAmmo);
                }

                this.on("hit.sprite", function(collision) {
                    if (collision.obj.isA("Key")) {
                        collision.obj.destroy();
                        this.p.hasKey = true
                    } else if (collision.obj.isA("Chest") && this.p.hasKey) {
                        console.log("Next Level1");
                    } else if (collision.obj.isA("AmmoCrate")) {
                        collision.obj.destroy();
                        this.p.currentAmmo += 5;
                    }
                });

                Q.input.on("fire", this, "fire");

            },
            step: function(dt) {
                if (Q.inputs["left"] && this.p.direction == "right") {
                    this.p.flip = "x";
                }
                if (Q.inputs["right"] && this.p.direction == "left") {
                    this.p.flip = false;
                }
            }
        });

        //Bullet
        Q.MovingSprite.extend("Bullet", {
            init: function(p) {
                this._super(p, {
                    asset: "fireb.png",
                });
                this.add("2d");
                this.gravity = 0;
                this.on("hit", this.destroy);
            }
        });

        /*
        Q.Sprite.extend("Chest", {
            init: function(p) {
                this._super(p, {
                    asset: "lock_red.png",
                    x: 490,
                    y: 420,
                });
                this.add("2d");
            }
        });

        Q.Sprite.extend("Key", {
            init: function(p) {
                this._super(p, {
                    asset: "key_red.png",
                    x: 350,
                    y: 420,
                });
                this.add("2d");
            }
        });

        Q.Sprite.extend("AmmoCrate", {
            init: function(p) {
                this._super(p, {
                    asset: "ammocrate.png",
                    x: 560,
                    y: 420,
                });
                this.add("2d");
            }
        });

        Q.component("enemySuperClass", {
            added: function() {
                var entity = this.entity;

                //Damage Player
                entity.on("bump.left,bump.right,bump.bottom", function(collision) {
                    if (collision.obj.isA("Player")) {
                        console.log("dead");
                    }
                });

                //Destroy if jumped on top
                entity.on("bump.top", function(collision) {
                    if (collision.obj.isA("Player")) {
                        //make the player jump
                        collision.obj.p.vy = -100;
                        this.destroy();
                    }
                });

                //Destroy of hitted by a Bullet
                entity.on("hit", function(collision) {
                    if (collision.obj.isA("Bullet")) {
                        this.destroy();
                    }
                });
            },

        });


        Q.Sprite.extend("GroundEnemy", {
            init: function(p) {
                this._super(p, {
                    vx: -100,
                    defaultDirection: "left"
                });
                this.add("2d, aiBounce, enemySuperClass");
            },
            step: function(dt) {
                var dirX = this.p.vx / Math.abs(this.p.vx);
                var ground = Q.stage().locate(this.p.x, this.p.y + this.p.h / 2 + 1, Q.SPRITE_DEFAULT);
                var nextTile = Q.stage().locate(this.p.x + dirX * this.p.w / 2 + dirX, this.p.y + this.p.h / 2 + 1, Q.SPRITE_DEFAULT);

                //if we are on ground and there is a cliff
                if (!nextTile && ground) {
                    if (this.p.vx > 0) {
                        if (this.p.defaultDirection == "right") {
                            this.p.flip = "x";
                        } else {
                            this.p.flip = false;
                        }
                    } else {
                        if (this.p.defaultDirection == "left") {
                            this.p.flip = "x";
                        } else {
                            this.p.flip = false;
                        }
                    }
                    this.p.vx = -this.p.vx;
                }
            }
        });

        Q.Sprite.extend("FlyingEnemy", {
            init: function(p) {
                this._super(p, {
                    vy: -100,
                    rangeY: 200,
                    gravity: 0
                });
                this.add("2d, enemySuperClass");

                this.p.initialY = this.p.y;
            },
            step: function(dt) {
                if (this.p.y - this.p.initialY >= this.p.rangeY && this.p.vy > 0) {
                    this.p.vy = -this.p.vy;
                } else if (-this.p.y + this.p.initialY >= this.p.rangeY && this.p.vy < 0) {
                    this.p.vy = -this.p.vy;
                }
            }
        });

        */
        //@TODO make multiple levels
        Q.scene("level1", function(stage) {
            var background = new Q.TileLayer({
                dataAsset: "origin.tmx",
                layerIndex: 0,
                sheet: "tiles",
                tileW: 70,
                tileH: 70,
                type: Q.SPRITE_NONE
            });
            stage.insert(background);

            stage.collisionLayer(new Q.TileLayer({
                dataAsset: "origin.tmx",
                layerIndex: 1,
                sheet: "tiles",
                tileW: 70,
                tileH: 70,
                type: Q.SPRITE_DEFAULT
            }));

            var player = stage.insert(new Q.Player());
            //var chest = stage.insert(new Q.Chest());
            //var key = stage.insert(new Q.Key());
            //var ammocrate = stage.insert(new Q.AmmoCrate());

            /*
            var levelAssets = [
                ["GroundEnemy", {
                    x: 18 * 70,
                    y: 6 * 70,
                    asset: "slime.png"
                }],
                ["GroundEnemy", {
                    x: 14 * 70,
                    y: 6 * 70,
                    asset: "slime.png"
                }],
                ["FlyingEnemy", {
                    x: 800,
                    y: 350,
                    rangeY: 70,
                    asset: "fly.png"
                }]
            ];

            stage.loadAssets(levelAssets);
            */

            stage.add("viewport").follow(player, {
                x: true,
                y: true
            }, {
                minX: 0,
                maxX: background.p.w,
                minY: 0,
                maxY: background.p.h
            });

        });

        /*
        Q.scene("level2", function(stage) {
            var background = new Q.TileLayer({
                dataAsset: "level2.tmx",
                layerIndex: 0,
                sheet: "tiles",
                tileW: 70,
                tileH: 70,
                type: Q.SPRITE_NONE
            });
            stage.insert(background);
        });
        */

        Q.scene("endGame", function(stage) {
            alert("game over");
            window.location = "";
        });

        Q.input.on('action', function() {
            Q.clearStage(1);
            alert("Next Scene!");
            Q.stageScene("level2");

            /*
            var level = Q.state.get("level");

            if (level > 1) {
                Q.stageScene('level' + (level - 1));
            } else {
                Q.stageScene('title');
            }
            */
        });

        //load assets
        Q.load("tiles.png, origin.tmx, wizard.png, fireb.png", function() {
            Q.sheet("tiles", "tiles.png", {
                tilew: 70,
                tileh: 70
            });
            Q.stageScene("level1");
        });

        function test() {
            console.log("test");
        }
    </script>
</body>

</html>
